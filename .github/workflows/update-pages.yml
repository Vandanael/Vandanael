name: Update Pages List
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Générer la liste et mettre à jour le README
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USER: ${{ github.repository_owner }}
        run: |
          # CORRECTION : On utilise 'gh api' au lieu de 'gh repo list'
          # Cela garantit l'accès au champ 'has_pages'
          gh api user/repos --paginate --jq 'map(select(.has_pages))' > repos.json
          
          python3 -c "
          import json, os

          user = os.environ['USER']
          try:
              with open('repos.json') as f:
                  repos = json.load(f)
          except:
              repos = []

          md_lines = []
          for r in repos:
              # Dans l'API brute, le champ s'appelle 'homepage' (peut être null)
              site_url = r.get('homepage')
              
              # Si pas d'URL personnalisée, on construit la par défaut
              if not site_url:
                  site_url = f'https://{user}.github.io/{r['name']}/'
              
              md_lines.append(f'- [{r['name']}]({site_url})')

          content = '\n'.join(md_lines)
          
          # Mise à jour du README
          with open('README.md', 'r') as f:
              readme = f.read()
          
          # ATTENTION : Assurez-vous que ces balises sont bien dans votre README.md
          start_marker = ''
          end_marker = ''
          
          start_idx = readme.find(start_marker)
          end_idx = readme.find(end_marker)
          
          if start_idx != -1 and end_idx != -1:
              # On garde les marqueurs et on insère le contenu entre eux
              start_idx += len(start_marker)
              new_readme = readme[:start_idx] + '\n' + content + '\n' + readme[end_idx:]
              with open('README.md', 'w') as f:
                  f.write(new_readme)
          else:
              print('Marqueurs introuvables dans le README.md')
          "
          
      - name: Commit et Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          # On ne commit que s'il y a des changements
          git diff --quiet && git diff --staged --quiet || (git commit -am "Mise à jour automatique des Pages" && git push)
