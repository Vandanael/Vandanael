name: Update Pages List
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      
      - name: G√©n√©rer la liste et mettre √† jour le README
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USER: ${{ github.repository_owner }}
        run: |
          # --- CORRECTION ICI ---
          # On interroge l'endpoint public "users/NOM/repos" au lieu de "user/repos"
          # Cela √©vite l'erreur 403
          gh api "users/$USER/repos?per_page=100&type=owner" --paginate --jq 'map(select(.has_pages))' > repos.json
          
          python3 -c "
          import json, os

          user = os.environ['USER']
          try:
              with open('repos.json') as f:
                  repos = json.load(f)
          except:
              print('Erreur ou fichier vide, aucun repo trouv√©.')
              repos = []

          md_lines = []
          for r in repos:
              # L'API peut renvoyer 'homepage' vide ou null
              site_url = r.get('homepage')
              
              # Si l'URL n'est pas d√©finie dans le repo, on la construit
              if not site_url:
                  site_url = f'https://{user}.github.io/{r['name']}/'
              
              # On ajoute la ligne avec une ic√¥ne
              md_lines.append(f'- üåç [{r['name']}]({site_url})')

          content = '\n'.join(md_lines)
          
          # Si la liste est vide (pas de pages trouv√©es), on met un message par d√©faut
          if not content:
              content = '_Aucun site d√©tect√© pour le moment._'

          # Lecture et √©criture du README
          with open('README.md', 'r') as f:
              readme = f.read()
          
          start_marker = ''
          end_marker = ''
          
          start_idx = readme.find(start_marker)
          end_idx = readme.find(end_marker)
          
          if start_idx != -1 and end_idx != -1:
              start_idx += len(start_marker)
              new_readme = readme[:start_idx] + '\n' + content + '\n' + readme[end_idx:]
              with open('README.md', 'w') as f:
                  f.write(new_readme)
              print('README mis √† jour avec succ√®s.')
          else:
              print('ERREUR : Marqueurs introuvables dans le README.')
          "
          
      - name: Commit et Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git diff --quiet && git diff --staged --quiet || (git commit -am "Mise √† jour automatique des Pages" && git push)
